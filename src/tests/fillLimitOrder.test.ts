import { it, expect } from "vitest";
import { parseSwap } from "../index";

require("dotenv").config();

const RPC_TEST_URL = process.env.RPC_TEST_URL;

if (!RPC_TEST_URL) {
  throw new Error("Missing environment variable `RPC_TEST_URL`");
}

// https://etherscan.io/tx/0xbe734b761ccd45cc60a5b4828eb83da96405d663567a46041b049627dddf347d
const txReceipt = {
  _type: "TransactionReceipt",
  blockHash:
    "0x97a80464d17d1eecbbd18818dfead2dc8ee369b7cccd5ebf9b0a95f29f72563f",
  blockNumber: 15929322,
  contractAddress: null,
  cumulativeGasUsed: "15712504",
  from: "0xa3b807A0B8E8Dd237eba760aB25be60349F3BF76",
  gasPrice: "12533139833",
  gasUsed: "158198",
  hash: "0xbe734b761ccd45cc60a5b4828eb83da96405d663567a46041b049627dddf347d",
  index: 192,
  logs: [
    {
      _type: "log",
      address: "0xdAC17F958D2ee523a2206206994597C13D831ec7",
      blockHash:
        "0x97a80464d17d1eecbbd18818dfead2dc8ee369b7cccd5ebf9b0a95f29f72563f",
      blockNumber: 15929322,
      data: "0x0000000000000000000000000000000000000000000000000000000000186a00",
      index: 366,
      topics: [
        "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef",
        "0x000000000000000000000000a3b807a0b8e8dd237eba760ab25be60349f3bf76",
        "0x00000000000000000000000096d3e863ecc5999e6833e73d807e554bb6cd6488",
      ],
      transactionHash:
        "0xbe734b761ccd45cc60a5b4828eb83da96405d663567a46041b049627dddf347d",
      transactionIndex: 192,
    },
    {
      _type: "log",
      address: "0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2",
      blockHash:
        "0x97a80464d17d1eecbbd18818dfead2dc8ee369b7cccd5ebf9b0a95f29f72563f",
      blockNumber: 15929322,
      data: "0x00000000000000000000000000000000000000000000000000038d7ea4c68000",
      index: 367,
      topics: [
        "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef",
        "0x00000000000000000000000096d3e863ecc5999e6833e73d807e554bb6cd6488",
        "0x000000000000000000000000a3b807a0b8e8dd237eba760ab25be60349f3bf76",
      ],
      transactionHash:
        "0xbe734b761ccd45cc60a5b4828eb83da96405d663567a46041b049627dddf347d",
      transactionIndex: 192,
    },
    {
      _type: "log",
      address: "0xDef1C0ded9bec7F1a1670819833240f027b25EfF",
      blockHash:
        "0x97a80464d17d1eecbbd18818dfead2dc8ee369b7cccd5ebf9b0a95f29f72563f",
      blockNumber: 15929322,
      data: "0xcfefbae3b29314e9067f2d43524b806bbda7485c8125ba2ad33bcef8c4ae27e900000000000000000000000096d3e863ecc5999e6833e73d807e554bb6cd6488000000000000000000000000a3b807a0b8e8dd237eba760ab25be60349f3bf760000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000dac17f958d2ee523a2206206994597c13d831ec70000000000000000000000000000000000000000000000000000000000186a0000000000000000000000000000000000000000000000000000038d7ea4c68000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
      index: 368,
      topics: [
        "0xab614d2b738543c0ea21f56347cf696a3a0c42a7cbec3212a5ca22a4dcff2124",
      ],
      transactionHash:
        "0xbe734b761ccd45cc60a5b4828eb83da96405d663567a46041b049627dddf347d",
      transactionIndex: 192,
    },
  ],
  logsBloom:
    "0x00000000000000000000000000000000800000000000000000000000000000000000200000000000200000000000010002000000080000000000000000000000000000000000000000000008000000000000000000000000000001000000000004000000080000000000000000000000000000000000200000000010000000000000000000000000000000000000000000000000000000000000000000100000008000000000000000000080000000000000000000000000000000000000004001000002000000000000000000000000000000000000010000000000000000000020200000000000000000000000000000000000000000000000000000000000",
  status: 1,
  to: "0xDef1C0ded9bec7F1a1670819833240f027b25EfF",
};

it("parses fillLimitOrder", async () => {
  const order = [
    "0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2",
    "0xdAC17F958D2ee523a2206206994597C13D831ec7",
    1000000000000000n,
    1600000n,
    0n,
    "0x96d3e863eCc5999e6833E73d807E554Bb6Cd6488",
    "0xa3b807A0B8E8Dd237eba760aB25be60349F3BF76",
  ];
  const data = await parseSwap({
    txReceipt,
    txDescription: {
      value: 0n,
      name: "fillLimitOrder",
      args: [order],
    },
    rpcUrl: RPC_TEST_URL,
  });

  expect(data).toEqual({
    tokenIn: {
      symbol: "USDT",
      amount: "1.6",
    },
    tokenOut: {
      symbol: "WETH",
      amount: "0.001",
    },
  });
});

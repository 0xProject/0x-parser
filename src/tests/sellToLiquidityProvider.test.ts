import { it, expect } from "vitest";
import { parseSwap } from "../index";

require("dotenv").config();

const RPC_TEST_URL = process.env.RPC_TEST_URL;

if (!RPC_TEST_URL) {
  throw new Error("Missing environment variable `RPC_TEST_URL`");
}

// https://etherscan.io/tx/0x2a4379d531695dd4f142730edb7720bb9d06dfb405322e0e16acbfd8ba4fcb98
const txReceipt = {
  _type: "TransactionReceipt",
  blockHash:
    "0xda449ac636042c6c5730e54ade5fd4226e4dfb4339538f6d9fcb733d96ced22c",
  blockNumber: 16594568,
  contractAddress: null,
  cumulativeGasUsed: "10472696",
  from: "0x4515957DAF1c5a1Cd2E24D000E909A0Ff6bE1975",
  gasPrice: "33080143688",
  gasUsed: "399281",
  hash: "0x2a4379d531695dd4f142730edb7720bb9d06dfb405322e0e16acbfd8ba4fcb98",
  index: 115,
  logs: [
    {
      _type: "log",
      address: "0xAf5191B0De278C7286d6C7CC6ab6BB8A73bA2Cd6",
      blockHash:
        "0xda449ac636042c6c5730e54ade5fd4226e4dfb4339538f6d9fcb733d96ced22c",
      blockNumber: 16594568,
      data: "0x000000000000000000000000000000000000000000000031d1a282b7ad55ed9c",
      index: 200,
      topics: [
        "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef",
        "0x0000000000000000000000004515957daf1c5a1cd2e24d000e909a0ff6be1975",
        "0x000000000000000000000000561b94454b65614ae3db0897b74303f4acf7cc75",
      ],
      transactionHash:
        "0x2a4379d531695dd4f142730edb7720bb9d06dfb405322e0e16acbfd8ba4fcb98",
      transactionIndex: 115,
    },
    {
      _type: "log",
      address: "0xAf5191B0De278C7286d6C7CC6ab6BB8A73bA2Cd6",
      blockHash:
        "0xda449ac636042c6c5730e54ade5fd4226e4dfb4339538f6d9fcb733d96ced22c",
      blockNumber: 16594568,
      data: "0xfffffffffffffffffffffffffffffffffffffffffffffec6fc8d66fd64ee26c6",
      index: 201,
      topics: [
        "0x8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925",
        "0x0000000000000000000000004515957daf1c5a1cd2e24d000e909a0ff6be1975",
        "0x000000000000000000000000def1c0ded9bec7f1a1670819833240f027b25eff",
      ],
      transactionHash:
        "0x2a4379d531695dd4f142730edb7720bb9d06dfb405322e0e16acbfd8ba4fcb98",
      transactionIndex: 115,
    },
    {
      _type: "log",
      address: "0xAf5191B0De278C7286d6C7CC6ab6BB8A73bA2Cd6",
      blockHash:
        "0xda449ac636042c6c5730e54ade5fd4226e4dfb4339538f6d9fcb733d96ced22c",
      blockNumber: 16594568,
      data: "0x000000000000000000000000000000000000000000000031d1a282b7ad55ed9c",
      index: 202,
      topics: [
        "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef",
        "0x000000000000000000000000561b94454b65614ae3db0897b74303f4acf7cc75",
        "0x0000000000000000000000003211c6cbef1429da3d0d58494938299c92ad5860",
      ],
      transactionHash:
        "0x2a4379d531695dd4f142730edb7720bb9d06dfb405322e0e16acbfd8ba4fcb98",
      transactionIndex: 115,
    },
    {
      _type: "log",
      address: "0xAf5191B0De278C7286d6C7CC6ab6BB8A73bA2Cd6",
      blockHash:
        "0xda449ac636042c6c5730e54ade5fd4226e4dfb4339538f6d9fcb733d96ced22c",
      blockNumber: 16594568,
      data: "0xffffffffffffffffffffffffffffffffffffffffffe77c6c296a0d70d5218996",
      index: 203,
      topics: [
        "0x8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925",
        "0x000000000000000000000000561b94454b65614ae3db0897b74303f4acf7cc75",
        "0x0000000000000000000000003211c6cbef1429da3d0d58494938299c92ad5860",
      ],
      transactionHash:
        "0x2a4379d531695dd4f142730edb7720bb9d06dfb405322e0e16acbfd8ba4fcb98",
      transactionIndex: 115,
    },
    {
      _type: "log",
      address: "0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48",
      blockHash:
        "0xda449ac636042c6c5730e54ade5fd4226e4dfb4339538f6d9fcb733d96ced22c",
      blockNumber: 16594568,
      data: "0x00000000000000000000000000000000000000000000000000000000294b07b2",
      index: 204,
      topics: [
        "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef",
        "0x0000000000000000000000003211c6cbef1429da3d0d58494938299c92ad5860",
        "0x000000000000000000000000561b94454b65614ae3db0897b74303f4acf7cc75",
      ],
      transactionHash:
        "0x2a4379d531695dd4f142730edb7720bb9d06dfb405322e0e16acbfd8ba4fcb98",
      transactionIndex: 115,
    },
    {
      _type: "log",
      address: "0xdf55670e27bE5cDE7228dD0A6849181891c9ebA1",
      blockHash:
        "0xda449ac636042c6c5730e54ade5fd4226e4dfb4339538f6d9fcb733d96ced22c",
      blockNumber: 16594568,
      data: "0x000000000000000000000000000000000000000000000000060f6607941d9b40",
      index: 205,
      topics: [
        "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef",
        "0x0000000000000000000000000000000000000000000000000000000000000000",
        "0x000000000000000000000000ecb456ea5365865ebab8a2661b0c503410e9b347",
      ],
      transactionHash:
        "0x2a4379d531695dd4f142730edb7720bb9d06dfb405322e0e16acbfd8ba4fcb98",
      transactionIndex: 115,
    },
    {
      _type: "log",
      address: "0x3211C6cBeF1429da3D0d58494938299C92Ad5860",
      blockHash:
        "0xda449ac636042c6c5730e54ade5fd4226e4dfb4339538f6d9fcb733d96ced22c",
      blockNumber: 16594568,
      data: "0x000000000000000000000000000000000000000000000000060f6607941d9b40",
      index: 206,
      topics: [
        "0x6059a38198b1dc42b3791087d1ff0fbd72b3179553c25f678cd246f52ffaaf59",
        "0x000000000000000000000000ecb456ea5365865ebab8a2661b0c503410e9b347",
      ],
      transactionHash:
        "0x2a4379d531695dd4f142730edb7720bb9d06dfb405322e0e16acbfd8ba4fcb98",
      transactionIndex: 115,
    },
    {
      _type: "log",
      address: "0x3211C6cBeF1429da3D0d58494938299C92Ad5860",
      blockHash:
        "0xda449ac636042c6c5730e54ade5fd4226e4dfb4339538f6d9fcb733d96ced22c",
      blockNumber: 16594568,
      data: "0x0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000031d1a282b7ad55ed9c000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000294b07b2",
      index: 207,
      topics: [
        "0xb2e76ae99761dc136e598d4a629bb347eccb9532a5f8bbd72e18467c3c34cc98",
        "0x000000000000000000000000561b94454b65614ae3db0897b74303f4acf7cc75",
      ],
      transactionHash:
        "0x2a4379d531695dd4f142730edb7720bb9d06dfb405322e0e16acbfd8ba4fcb98",
      transactionIndex: 115,
    },
    {
      _type: "log",
      address: "0x561B94454b65614aE3db0897B74303f4aCf7cc75",
      blockHash:
        "0xda449ac636042c6c5730e54ade5fd4226e4dfb4339538f6d9fcb733d96ced22c",
      blockNumber: 16594568,
      data: "0x000000000000000000000000af5191b0de278c7286d6c7cc6ab6bb8a73ba2cd6000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000000000000000000000000031d1a282b7ad55ed9c00000000000000000000000000000000000000000000000000000000294b07b243757276650000000000000000000000000000000000000000000000000000000000000000000000000000003211c6cbef1429da3d0d58494938299c92ad5860000000000000000000000000407b4128e9ecad8769b2332312a9f655cb9f5f3a0000000000000000000000004515957daf1c5a1cd2e24d000e909a0ff6be1975",
      index: 208,
      topics: [
        "0x83dc79d57dbf7f65897db5b817ef3c45ebb363086f52ba01bb57d0cdef08dace",
      ],
      transactionHash:
        "0x2a4379d531695dd4f142730edb7720bb9d06dfb405322e0e16acbfd8ba4fcb98",
      transactionIndex: 115,
    },
    {
      _type: "log",
      address: "0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48",
      blockHash:
        "0xda449ac636042c6c5730e54ade5fd4226e4dfb4339538f6d9fcb733d96ced22c",
      blockNumber: 16594568,
      data: "0x00000000000000000000000000000000000000000000000000000000294b07b2",
      index: 209,
      topics: [
        "0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef",
        "0x000000000000000000000000561b94454b65614ae3db0897b74303f4acf7cc75",
        "0x0000000000000000000000004515957daf1c5a1cd2e24d000e909a0ff6be1975",
      ],
      transactionHash:
        "0x2a4379d531695dd4f142730edb7720bb9d06dfb405322e0e16acbfd8ba4fcb98",
      transactionIndex: 115,
    },
    {
      _type: "log",
      address: "0xDef1C0ded9bec7F1a1670819833240f027b25EfF",
      blockHash:
        "0xda449ac636042c6c5730e54ade5fd4226e4dfb4339538f6d9fcb733d96ced22c",
      blockNumber: 16594568,
      data: "0x000000000000000000000000af5191b0de278c7286d6c7cc6ab6bb8a73ba2cd6000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000000000000000000000000031d1a282b7ad55ed9c00000000000000000000000000000000000000000000000000000000294b07b2000000000000000000000000561b94454b65614ae3db0897b74303f4acf7cc750000000000000000000000004515957daf1c5a1cd2e24d000e909a0ff6be1975",
      index: 210,
      topics: [
        "0x40a6ba9513d09e3488135e0e0d10e2d4382b792720155b144cbea89ac9db6d34",
      ],
      transactionHash:
        "0x2a4379d531695dd4f142730edb7720bb9d06dfb405322e0e16acbfd8ba4fcb98",
      transactionIndex: 115,
    },
  ],
  logsBloom:
    "0x0000008000120000000000080000000000000000000040000000000800000000000000000000200000000800000000040200000080000000000000000020000000000000000000300a00004800000040000000000000000000000000000000000000400002100000000004000000084000000000000000000000041000000000000000000000000000200000000000000000000001000000000000000000000002800080000020001002400404000400008000002000000000000000000000c001000002000000000000000000001000000000000000001000000000000020000010000000000020008000000080000000000000000000000000000000000040",
  status: 1,
  to: "0xDef1C0ded9bec7F1a1670819833240f027b25EfF",
};

it("parses swap for sellToLiquidityProvider", async () => {
  const data = await parseSwap({
    txReceipt,
    txDescription: { name: "sellToLiquidityProvider", value: 0n, args: [] },
    rpcUrl: RPC_TEST_URL,
  });

  expect(data).toEqual({
    tokenIn: {
      symbol: "STG",
      amount: "918.996239437320809884",
      address: "0xAf5191B0De278C7286d6C7CC6ab6BB8A73bA2Cd6",
    },
    tokenOut: {
      symbol: "USDC",
      amount: "692.783026",
      address: "0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48",
    },
  });
});
